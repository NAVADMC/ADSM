{% extends "ScenarioCreator/Fragment.html" %}
{% load floppyforms %}
{% load crispy_forms_tags  %}
{% load db_status_tags  %}



{% block content %}

    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/jquery-ui.min.css" />
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/jquery-ui.structure.min.css" />
    <script src="{{ STATIC_URL }}js/jquery-ui.min.js"></script>

    <h1 id="title">{{ title }}</h1>

    <label>Destruction Reason Order</label>
    <ul id="priorities" class="ui-sortable">
        {% for value in reasons %}
            <li class="ui-state-default ui-sortable-handle tab-list top-level-priority reasons" title="Drag to change Vaccination Priority"><span class="pull-right completed"></span>
                {{  value }}
            </li>
        {% endfor %}
    </ul>

    <form class="ajax" method="post" action="" id="destruction-global-form">
        {% crispy form %}
        {% if form_errors %}
            <div id='form-errors'>{{ form_errors }}</div>
        {% endif %}
    </form>

    <label>Destruction Priority Order</label>
    <ul id="priorities" class="ui-sortable">
        {% for value in priorities %}
            <li class="ui-state-default ui-sortable-handle tab-list top-level-priority priorities" title="Drag to change Vaccination Priority"><span class="pull-right completed"></span>
                {{  value }}
            </li>
        {% endfor %}
    </ul>

    <script>
            function submitDestructionGlobalForm() {
                var priorityString = "";
                var topLevelItems = document.getElementsByClassName("reasons");

                for (var i = 0; i < topLevelItems.length; ++i) {
                    var priority = topLevelItems[i].textContent.split(',')[0].split("\n")[1].trim();

                    priorityString += priority + ", ";

                }
                priorityString = priorityString.slice(0, priorityString.length - 2);

                document.getElementById("id_destruction_reason_order").value = priorityString;

                document.getElementById("destruction-global-form").submit();
            }

            function submitDestructionPriorityOrder() {
                var priorityString = "";
                var topLevelItems = document.getElementsByClassName("priorities");

                for (var i = 0; i < topLevelItems.length; ++i) {
                    var priority = topLevelItems[i].textContent.split(',')[0].split("\n")[1].trim();

                    priorityString += priority + ", ";

                }
                priorityString = priorityString.slice(0, priorityString.length - 2);

                document.getElementById("id_destruction_priority_order").value = priorityString;

                document.getElementById("destruction-global-form").submit();
            }

            $(function() {
                $( ".ui-sortable" ).sortable({
                    update: function(event, ui) {
                        $('#submit-id-submit').removeAttr('disabled').addClass('unsaved');
                    }
                });
                $( ".ui-sortable" ).disableSelection();

                $('#priorities>.ui-sortable-handle').mouseenter(function(){
                    $('#priorities>.ui-sortable-handle').removeClass('active')
                    $(this).addClass('active')
                });
                $(':input').hover(function(){
                    $('#priorities *').removeClass('active')
                })
            });
        </script>

        <div class="buttonHolder" style="position:absolute; bottom:72px;">
            <button type="button" class="btn btn-default btn-cancel" id="id-cancel" onclick="window.location.reload();">Cancel</button>
            <button type="submit" class="btn btn-primary btn-save" id="submit-id-submit" disabled onclick="submitDestructionGlobalForm(); submitDestructionPriorityOrder();">Apply</button>
        </div>

{% endblock %}